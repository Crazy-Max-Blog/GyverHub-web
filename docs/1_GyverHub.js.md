# GyverHub.js

Клиент базируется на библиотеке GyverHub.js (сейчас код находится в src/inc/lib/hub). Библиотека может использоваться отдельно от клиента (например, для встраивания клиентской части хаба в свой сайт).

### Обзор архитектуры

GyverHub.js состоит из:
1) GyverHub - основной класс клиента,
2) Device - класс устройства,
3) Connection и его потомки - различные виды подключения клиента к устройству,
4) Вспомогательные класс и функции.

### Использование

Общая схема создания клиента для использования выглядит так:

1) Создание экземпляра класс GyverHub.
2) Добавление способов подключения через метод `addConnection(cls)`.
3) Добавление обработчиков событий.
4) (опционально) загрузка сохраненных настроек.
5) Запуск связи через метод `begin()`.

После этого можно использовать методы `search()` и `discover()` для поиска устройств и подключения к ним и метод `dev()` для получения экземпляра устройства и взаимодействия с ним.

# Классы

## GyverHub

### События

`connectionstatechange`, `connectionstatechange.<connection name>`

ConnectionStateChangeEvent, срабатывает при изменении состояния соединения.

`discoverfinished`

Срабатывает после завершения поиска устройств через search() или discover().

`deviceinfochanged`

DeviceEvent, срабатывает после получения от устройства новой информации (Device.info) в пакете discover.

`deviceadded`

DeviceEvent, срабатывает при добавлении нового устройства, которое было найдено через search().

`devicecreated`

DeviceEvent, срабатывает при создании экземпляра класс Device. Это событие должно использоваться только для добавления обработчиков событий на устройство.

### Свойства

static `api_v`

Версия API устройства, с которым может работать библиотека.

`config`

Config, конфигурация библиотеки.

`clientId`

ID клиента.

`prefix`

Префикс для поиска устройств.

### Методы

`addConnection(cls)`

Добавляет новый тип подключения. cls - класс подключения, наследник Connection. Возвращает экземпляр этого класса.

async `begin()`

Запускает подключения.

async `discover()`

Разрывает и заново устанавливает связь со всеми изветсными устройствами. Зта функция запускает поиск устройств, но не дожидается его окончания; чтобы в момент окончания поиска сработает событие discoverfinished.

async `search()`

Запускает поиск новых устройств. При этом для уже известных устройств могут быть найдены новые способы связи. Зта функция запускает поиск устройств, но не дожидается его окончания; чтобы в момент окончания поиска сработает событие discoverfinished.

`getAllPrefixes()`

Возвращает список всех известных префиксов (текущий и префиксы устройств), без повторений.

`getDeviceIds()`

Возврщает список ID известных устройств.

`dev(id)`

Возвращает экземпляр класса Device по ID устройства или null если устройство неизвестно.

`addDevice(data, [conn])`

Добавляет информацию об устройстве. data - объект, аналогичный пакету discover.

`moveDevice(id, dir)`

Перемещает устройство в списке на 1 позицию вперед (dir = 1) или назад (dir = -1).

`deleteDevice(id)`

Удаляет устройство.

## Device

### События

`connectionstatus`

DeviceConnectionStatusEvent, срабатывает при изменении статуса соединения с устройством (только для устройства в фокусе).

`connectionchanged`

DeviceEvent, срабатывает после изменения списка активных способов подключения (см. свойство active_connections).

`transferstart`

DeviceEvent, срабатывает перед началом обмена данными с устройством (кроме команд unfocus и fsAbort - потому что устройство не отвечает на них).

`transferend`

DeviceEvent, срабатывает после окончания обмена данными с устройством (см. событие transferstart).

`transfersuccess`

DeviceEvent, срабатывает после успешного окончания обмена данными с устройством (см. событие transferstart).

`transfererror`

DeviceEvent, срабатывает после неуспешного окончания обмена данными с устройством (см. событие transferstart).

`command`, `command.<packet type>`

DeviceCommandEvent, срабатывает при получении от устройства пакета соответствующего типа.

`update`

DeviceUpdateEvent, срабатывает при получении от устройства обновления через пакет с типом update или другими способами. В отличие от события command.update срабатывает на каждое обновление (если устройство отправило несколько обновлений в одном пакете).

`error`

DeviceErrorEvent, срабатывает при получении от устройства пакета типа error или при другой ошибке устройства, которая не может быть проброшена в виде исключения.

### Свойства

`active_connections`

Список соединений, через которые доступна связь с этим устройством.

`info`

Информация об устройстве (как в пакете типа discover).

### Методы

`isModuleEnabled(mod)`

Возвращает true, если указанный модуль включен на устройстве.

`isHttpAccessable()`

Возвращает true, если устройство доступно по HTTP.

`isConnected()`

Возвращает true, если есть подключения, на которых доступно это устройство.

`getConnection()`

Возвращает объект соединения, на котором доступно это устройство, имеющий наивысший приоритет, или null если таких соединений нет.

### Методы взаимодействия с устройством

async `getInfo()`

Запрашивает и возвращает информацию об устройстве. Возвращает undefined если устройство успешно не передало информацию.

async `reboot()`

Передает на устройство команду на перезагрузку. Эта функция завершается после получения ответа, но устройство не перезагружается сразу.

async `sendCli(command)`

Отправляет на устройство CLI-команду и дожидается подтверждения.

async `updateUi()`

Запрашивает с устройства обновление UI и возвращает его.

async `set(name, value)`

Передает команду set и дожидается подтверждения. Если устройство инициировало обновление UI - возвращает его.

async `focus()`

Устанавливает фокус на устройство. Возвращает обновление UI.

async `unfocus()`

Снимает фокус с устройства.

async `deleteFile(path)`

Удаляет файл из ФС устройства. Возвращает список файлов.

async `createFile(path)`

Создает файл на ФС устройства. Возвращает список файлов.

async `renameFile(path, new_name)`

Переименовывает файл на ФС устройства. Возвращает список файлов.

async `formatFS()`

Форматирует ФС устройства. Возвращает список файлов.

async `updateFileList()`

Получает и возвращает список файлов на ФС устройства.

async `fsStop()`

Останавливает передачу файла или OTA обновления между устройством и клиентом.

async `upload(file, path, progress = undefined)`

Загружает файл на устройство. file - Blob содержимое файла. progress - функция, которая будет вызываться по мере передачи данных с аргументом - процент завершения передачи.

async `fetch(path, type, progress = undefined)`

Скачивает файл с устройства. Если type = 'text' возвращает строку - содержимое файла в кодировке UTF-8, если type = 'url' возвращает base64 URI содержимого файла. progress - функция, которая будет вызываться по мере передачи данных с аргументом - процент завершения передачи.

async `otaUrl(type, url)`

Выполняет OTA обновление по URL. type - 'flash' или 'fs'.

async `uploadOta(file, type, progress = undefined)`

Выполняет OTA обновление. file - Blob содержимое файла обновления. type - 'flash' или 'fs'. progress - функция, которая будет вызываться по мере передачи данных с аргументом - процент завершения передачи.
